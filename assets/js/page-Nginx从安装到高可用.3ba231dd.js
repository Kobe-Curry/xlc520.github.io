(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{562:function(s,a,n){"use strict";n.r(a);var e=n(1),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx从安装到高可用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx从安装到高可用"}},[s._v("#")]),s._v(" Nginx从安装到高可用")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("原文：blog.csdn.net/qq_34886352/article/details/103581973\n第1-100期：100期Java项目整理\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h3",{attrs:{id:"一、nginx安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、nginx安装"}},[s._v("#")]),s._v(" 一、Nginx安装")]),s._v(" "),n("h5",{attrs:{id:"_1、去官网http-nginx-org-下载对应的nginx包-推荐使用稳定版本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、去官网http-nginx-org-下载对应的nginx包-推荐使用稳定版本"}},[s._v("#")]),s._v(" 1、去官网http://nginx.org/下载对应的nginx包，推荐使用稳定版本")]),s._v(" "),n("h5",{attrs:{id:"_2、上传nginx到linux系统"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、上传nginx到linux系统"}},[s._v("#")]),s._v(" 2、上传nginx到linux系统")]),s._v(" "),n("h5",{attrs:{id:"_3、安装依赖环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、安装依赖环境"}},[s._v("#")]),s._v(" 3、安装依赖环境")]),s._v(" "),n("p",[s._v("(1)安装gcc环境")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install gcc-c++\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(2)安装PCRE库，用于解析正则表达式")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install -y pcre pcre-devel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(3)zlib压缩和解压缩依赖")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install -y zlib zlib-devel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(4)SSL 安全的加密的套接字协议层，用于HTTP安全传输，也就是https")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install -y openssl openssl-devel\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_4、解压-需要注意-解压后得到的是源码-源码需要编译后才能安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、解压-需要注意-解压后得到的是源码-源码需要编译后才能安装"}},[s._v("#")]),s._v(" 4、解压，需要注意，解压后得到的是源码，源码需要编译后才能安装")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tar -zxvf nginx-1.16.1.tar.gz\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_5、编译之前-先创建nginx临时目录-如果不创建-在启动nginx的过程中会报错"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5、编译之前-先创建nginx临时目录-如果不创建-在启动nginx的过程中会报错"}},[s._v("#")]),s._v(" 5、编译之前，先创建nginx临时目录，如果不创建，在启动nginx的过程中会报错")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("mkdir /var/temp/nginx -p\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_6、在nginx目录-输入如下命令进行配置-目的是为了创建makefile文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6、在nginx目录-输入如下命令进行配置-目的是为了创建makefile文件"}},[s._v("#")]),s._v(" 6、在nginx目录，输入如下命令进行配置，目的是为了创建makefile文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./configure \\   \n--prefix=/usr/local/nginx \\    \n--pid-path=/var/run/nginx/nginx.pid \\    \n--lock-path=/var/lock/nginx.lock \\    \n--error-log-path=/var/log/nginx/error.log \\    \n--http-log-path=/var/log/nginx/access.log \\    \n--with-http_gzip_static_module \\    \n--http-client-body-temp-path=/var/temp/nginx/client \\    \n--http-proxy-temp-path=/var/temp/nginx/proxy \\    \n--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\    \n--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\    \n--http-scgi-temp-path=/var/temp/nginx/scgi\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("注：代表在命令行中换行，用于提高可读性配置命令：")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/xlc520/MyImage/MdImg/640-164346363259473.jpg",alt:"图片",loading:"lazy"}})]),s._v(" "),n("h5",{attrs:{id:"_7、make编译-安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7、make编译-安装"}},[s._v("#")]),s._v(" 7、make编译&安装")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("make\nmake install\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h5",{attrs:{id:"_8、进入sbin目录启动nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8、进入sbin目录启动nginx"}},[s._v("#")]),s._v(" 8、进入sbin目录启动nginx")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("启动：nginx\n停止：./nginx -s stop\n重新加载：./nginx -s reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h3",{attrs:{id:"二、配置反向代理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、配置反向代理"}},[s._v("#")]),s._v(" 二、配置反向代理")]),s._v(" "),n("p",[s._v("1、配置upstream")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("2、配置server")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h3",{attrs:{id:"三、配置负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、配置负载均衡"}},[s._v("#")]),s._v(" 三、配置负载均衡")]),s._v(" "),n("p",[s._v("nginx默认采用轮训的方式进行负载均衡")]),s._v(" "),n("p",[s._v("1、使用加权轮询")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("2、hash负载均衡")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    ip_hash\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("hash算法实际上只会计算 192.168.1这段做哈希")]),s._v(" "),n("p",[s._v("使用ip_hash的注意点：")]),s._v(" "),n("ul",[n("li",[s._v("不能把后台服务器直接移除，只能标记down.")])]),s._v(" "),n("p",[s._v("3、url hash负载均衡")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    hash $request_url;\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("4、最小连接负载均衡")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    least_conn;\n\n    server 192.168.1.173:8080;\n    server 192.168.1.174:8080;\n    server 192.168.1.175:8080;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h3",{attrs:{id:"四、upstream指令参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、upstream指令参数"}},[s._v("#")]),s._v(" 四、upstream指令参数")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("max_conns")]),s._v("：限制最大同时连接数 1.11.5之前只能用于商业版")]),s._v(" "),n("li",[n("code",[s._v("slow_start")]),s._v("：单位秒，权重在指定时间内从1上升到指定值，不适用与hash负载均衡、随机负载均衡 如果在 upstream 中只有一台 server，则该参数失效（商业版才有）")]),s._v(" "),n("li",[n("code",[s._v("down")]),s._v("：禁止访问")]),s._v(" "),n("li",[n("code",[s._v("backup")]),s._v("：备用机 只有在其他服务器无法访问的时候才能访问到 不适用与hash负载均衡、随机负载均衡")]),s._v(" "),n("li",[n("code",[s._v("max_fails")]),s._v("：表示失败几次，则标记server已宕机，剔出上游服务 默认值1")]),s._v(" "),n("li",[n("code",[s._v("fail_timeout")]),s._v("：表示失败的重试时间 默认值10")])]),s._v(" "),n("p",[s._v("1、keepalived")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n\n    keepalive 32; #保持的连接数\n}\n\nserver {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n        proxy_http_version 1.1; #连接的协议版本\n        proxy_set_header Connection ""; 清空连接请求头\n    }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("2、控制浏览器缓存")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listem  80;\n    server_name www.tomcats.com;\n\n    location / {\n        proxy_pass http://tomcats;\n               expires 10s;  #浏览器缓存10秒钟\n               #expires @22h30m  #在晚上10点30的时候过期\n               #expires -1h  #缓存在一小时前时效\n               #expires epoch  #不设置缓存\n               #expires off  #缓存关闭，浏览器自己控制缓存\n               #expires max  #最大过期时间\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("3、反向代理缓存")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("upstream [proxyName] {\n    server 192.168.1.173:8080 weight=1;\n    server 192.168.1.174:8080 weight=5;\n    server 192.168.1.175:8080 weight=2;\n}\n\n#proxy_cache_path 设置缓存保存的目录的位置\n#keys_zone设置共享内以及占用的空间大小\n#mas_size 设置缓存最大空间\n#inactive 缓存过期时间，错过此时间自动清理\n#use_temp_path 关闭零时目录\nproxy_cache_path /usr/local/nginx/upsteam_cache keys_zone=mycache:5m max_size=1g inactive=8h use_temp_path=off;\n\nserver {\n    listem  80;\n    server_name www.tomcats.com;\n    #开启并使用缓存\n    proxy_cache mycache;\n    #针对200和304响应码的缓存过期时间\n    proxy_cache_valid 200 304 8h;   \n\n    location / {\n        proxy_pass http://tomcats;\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h3",{attrs:{id:"五、配置ssl证书提供https访问"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五、配置ssl证书提供https访问"}},[s._v("#")]),s._v(" 五、配置ssl证书提供https访问")]),s._v(" "),n("h5",{attrs:{id:"_1-安装ssl模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装ssl模块"}},[s._v("#")]),s._v(" 1. 安装SSL模块")]),s._v(" "),n("p",[s._v("要在nginx中配置https，就必须安装ssl模块，也就是: "),n("code",[s._v("http_ssl_module")]),s._v("。")]),s._v(" "),n("p",[s._v("进入到nginx的解压目录："),n("code",[s._v("/home/software/nginx-1.16.1")])]),s._v(" "),n("p",[s._v("新增ssl模块(原来的那些模块需要保留)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./configure \\\n--prefix=/usr/local/nginx \\\n--pid-path=/var/run/nginx/nginx.pid \\\n--lock-path=/var/lock/nginx.lock \\\n--error-log-path=/var/log/nginx/error.log \\\n--http-log-path=/var/log/nginx/access.log \\\n--with-http_gzip_static_module \\\n--http-client-body-temp-path=/var/temp/nginx/client \\\n--http-proxy-temp-path=/var/temp/nginx/proxy \\\n--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \\\n--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \\\n--http-scgi-temp-path=/var/temp/nginx/scgi  \\\n--with-http_ssl_module\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("p",[s._v("编译和安装")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("make\nmake install\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h5",{attrs:{id:"_2、配置https"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、配置https"}},[s._v("#")]),s._v(" 2、配置HTTPS")]),s._v(" "),n("p",[s._v("把ssl证书 "),n("code",[s._v("*.crt")]),s._v(" 和 私钥 "),n("code",[s._v("*.key")]),s._v(" 拷贝到"),n("code",[s._v("/usr/local/nginx/conf")]),s._v("目录中。")]),s._v(" "),n("p",[s._v("新增 server 监听 443 端口：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listen       443;\n    server_name  www.imoocdsp.com;\n    # 开启ssl\n    ssl     on;\n    # 配置ssl证书\n    ssl_certificate      1_www.imoocdsp.com_bundle.crt;\n    # 配置证书秘钥\n    ssl_certificate_key  2_www.imoocdsp.com.key;\n    # ssl会话cache\n    ssl_session_cache    shared:SSL:1m;\n    # ssl会话超时时间\n    ssl_session_timeout  5m;\n    # 配置加密套件，写法遵循 openssl 标准\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;\n    ssl_prefer_server_ciphers on;\n    \n    location / {\n        proxy_pass http://tomcats/;\n        index  index.html index.htm;\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("h3",{attrs:{id:"六、配置ha-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六、配置ha-nginx"}},[s._v("#")]),s._v(" 六、配置ha nginx")]),s._v(" "),n("h5",{attrs:{id:"_1、安装keepalived"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、安装keepalived"}},[s._v("#")]),s._v(" 1、安装keepalived")]),s._v(" "),n("p",[s._v("(1)下载")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("https://www.keepalived.org/download.html\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(2)解压")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("tar -zxvf keepalived-2.0.18.tar.gz\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(3)使用configure命令配置安装目录与核心配置文件所在位置：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./configure --prefix=/usr/local/keepalived --sysconf=/etc\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[n("strong",[s._v("prefix")]),s._v("：keepalived安装的位置sysconf：keepalived核心配置文件所在位置，固定位置，改成其他位置则keepalived启动不了，"),n("code",[s._v("/var/log/messages")]),s._v("中会报错")]),s._v(" "),n("li",[n("strong",[s._v("sysconf")]),s._v("：keepalived核心配置文件所在位置，固定位置，改成其他位置则keepalived启动不了，"),n("code",[s._v("/var/log/messages")]),s._v("中会报错")])]),s._v(" "),n("p",[s._v("配置过程中可能会出现警告信息，如下所示：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("*** WARNING - this build will not support IPVS with IPv6. Please install libnl/libnl-3 dev libraries to support IPv6 with IPVS.\n\n# 安装libnl/libnl-3依赖\nyum -y install libnl libnl-devel  \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("(4)安装keepalived")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("make && make install\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(5)配置文件 在"),n("code",[s._v("/etc/keepalived/keepalived.conf")])]),s._v(" "),n("p",[s._v("(6)忘记安装配置的目录，则通过如下命令找到：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("whereis keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(7)启动keepalived")]),s._v(" "),n("p",[s._v("进入sbin目录")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("./keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_2、配置keepalived-主机"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、配置keepalived-主机"}},[s._v("#")]),s._v(" 2、配置keepalived 主机")]),s._v(" "),n("p",[s._v("(1)通过命令 "),n("code",[s._v("vim keepalived.conf")]),s._v(" 打开配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs { \n    # 路由id：当前安装keepalived的节点主机标识符，保证全局唯一 \n    router_id keep_171 \n} \n\nvrrp_instance VI_1 { \n    # 表示状态是MASTER主机还是备用机BACKUP \n    state MASTER \n    # 该实例绑定的网卡 \n    interface ens33 \n    # 保证主备节点一致即可 \n    virtual_router_id 51 \n    # 权重，master权重一般高于backup，如果有多个，那就是选举，谁的权重高，谁就当选 \n    priority 100 \n    # 主备之间同步检查时间间隔，单位秒 \n    advert_int 2 \n    # 认证权限密码，防止非法节点进入 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    # 虚拟出来的ip，可以有多个（vip） \n    virtual_ipaddress { \n        192.168.1.161 \n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("p",[s._v("附：查看网卡信息命令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ip addr\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(2)启动keepalived")]),s._v(" "),n("p",[s._v("(3)查看进程")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ps -ef|grep keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(4)查看vip(虚拟ip)")]),s._v(" "),n("p",[s._v("在网卡ens33下，多了一个"),n("code",[s._v("192.168.1.161")]),s._v("，这个就是虚拟ip")]),s._v(" "),n("h5",{attrs:{id:"_3、把keepalived注册为系统服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、把keepalived注册为系统服务"}},[s._v("#")]),s._v(" 3、把keepalived注册为系统服务")]),s._v(" "),n("p",[s._v("(1)拷贝配置文件")]),s._v(" "),n("ul",[n("li",[s._v("将keepalived目录下"),n("code",[s._v("etc/init.d/keepalived")]),s._v("拷贝到"),n("code",[s._v("/etc/init.d/")]),s._v("下")]),s._v(" "),n("li",[s._v("将keepalived目录下"),n("code",[s._v("etc/sysconfig/keepalived")]),s._v("拷贝到"),n("code",[s._v("/etc/sysconfig/")]),s._v("下")])]),s._v(" "),n("p",[s._v("(2)刷新systemctl")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl daemon-reload\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(3)启动、停止、重启keepalived")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#启动\nsystemctl start keepalived.service\n#停止\nsystemctl stop keepalived.service\n#重启\nsystemctl restart keepalived.service\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h5",{attrs:{id:"_4、实现双机主备高可用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、实现双机主备高可用"}},[s._v("#")]),s._v(" 4、实现双机主备高可用")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/xlc520/MyImage/MdImg/640-164346363259474.webp",alt:"图片",loading:"lazy"}})]),s._v(" "),n("p",[s._v("(1)修改备机配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs { \n    router_id keep_172 \n} \nvrrp_instance VI_1 { \n    # 备用机设置为BACKUP \n    state BACKUP \n    interface ens33 \n    virtual_router_id 51 \n    # 权重低于MASTER \n    priority 80 \n    advert_int 2 \n    authentication { \n        auth_type PASS auth_pass 1111 \n    }\n    virtual_ipaddress {\n        # 注意：主备两台的vip都是一样的，绑定到同一个vip \n        192.168.1.161 \n    } \n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("(2) 启动 Keepalived")]),s._v(" "),n("p",[s._v("(3) 访问vip即可访问主机，当主机失效时访问vip就会访问到备机")]),s._v(" "),n("h5",{attrs:{id:"_5、keepalived配置nginx自动重启"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5、keepalived配置nginx自动重启"}},[s._v("#")]),s._v(" 5、keepalived配置nginx自动重启")]),s._v(" "),n("p",[s._v("(1)编写脚本")]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("/etc/keepalived/")]),s._v("下创建脚本"),n("code",[s._v("check_nginx_alive_or_not")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#!/bin/bash \n\nA=`ps -C nginx --no-header |wc -l` \n# 判断nginx是否宕机，如果宕机了，尝试重启 \nif [ $A -eq 0 ];then \n    /usr/local/nginx/sbin/nginx \n    # 等待一小会再次检查nginx，如果没有启动成功，则停止keepalived，使其启动备用机 \n    sleep 3 \n        if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then \n            killall keepalived \n        fi \nfi\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("(2)添加运行权限")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("chmod +x /etc/keepalived/check_nginx_alive_or_not.sh\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(3)配置keepalived监听nginx脚本")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('vrrp_script check_nginx_alive { \n    script "/etc/keepalived/check_nginx_alive_or_not.sh" \n    interval 2 # 每隔两秒运行上一行脚本 \n    weight 10 # 如果脚本运行失败，则升级权重+10 \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("(4)在vrrp_instance中新增监控的脚本")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("track_script { \n    check_nginx_alive # 追踪 nginx 脚本\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("(5)重启Keepalived使得配置文件生效")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl restart keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_6、keepalived双主热备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6、keepalived双主热备"}},[s._v("#")]),s._v(" 6、keepalived双主热备")]),s._v(" "),n("p",[s._v("(1)配置DNS轮询")]),s._v(" "),n("p",[s._v("在同一个域名下配置两个ip，自行百度")]),s._v(" "),n("p",[s._v("(2)配置第一台主机")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs {\n    router_id keep_171 \n} \nvrrp_instance VI_1 { \n    state MASTER i\n    nterface ens33 \n    virtual_router_id 51 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.161 \n    } \n} \n\nvrrp_instance VI_2  {\n    state BACKUP \n    interface ens33 \n    virtual_router_id 52 \n    priority 80 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.162 \n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("(3)配置第二台主机")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs {\n    router_id keep_172 \n} \nvrrp_instance VI_1 { \n    state BACKUP \n    interface ens33 \n    virtual_router_id 51 \n    priority 80 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.161\n    }\n} \n\nvrrp_instance VI_2 {\n    state MASTER \n    interface ens33 \n    virtual_router_id 52 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.162 \n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("p",[s._v("(4)重启两台Keepalived")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl restart keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"七、lvs-linux-virtual-server-实现高可用负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#七、lvs-linux-virtual-server-实现高可用负载均衡"}},[s._v("#")]),s._v(" 七、LVS（Linux Virtual Server）实现高可用负载均衡")]),s._v(" "),n("h5",{attrs:{id:"_1、为什么要使用lvs-nginx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、为什么要使用lvs-nginx"}},[s._v("#")]),s._v(" 1、为什么要使用LVS+Nginx")]),s._v(" "),n("ul",[n("li",[s._v("lvs基于四层负载均衡，工作效率较Nginx的七层负载更高，使用LVS搭建Nginx集群，可以提高性能")]),s._v(" "),n("li",[s._v("四层负载均衡无法对信息处理，只能通过ip+端口的形式转发，所以需要七成负载进行数据的处理")]),s._v(" "),n("li",[s._v("Nginx接收请求来回，LVS可以只接受不响应")])]),s._v(" "),n("h5",{attrs:{id:"_2、lvs的三种模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、lvs的三种模式"}},[s._v("#")]),s._v(" 2、LVS的三种模式")]),s._v(" "),n("p",[s._v("(1)NAT模式")]),s._v(" "),n("ul",[n("li",[s._v("客户端将请求发往LVS，LVS会选择一台服务器响应请求，服务器将结果返回给LVS，LVS再返回给客户端。")]),s._v(" "),n("li",[s._v("在NAT模式中，服务器的网关必须指向LVS，否则报文无法送达客户端")]),s._v(" "),n("li",[s._v("NAT 技术将请求的报文和响应的报文都需要通过LVS进行地址改写，因此网站访问量比较大的时候负载均衡调度器有比较大的瓶颈，一般要求最多之能 10-20 台节点")]),s._v(" "),n("li",[s._v("NAT 模式支持对 IP 地址和端口进行转换。即用户请求的端口和真实服务器的端口可以不一致")])]),s._v(" "),n("p",[s._v("(2)TUN模式")]),s._v(" "),n("ul",[n("li",[s._v("客户端将请求发往LVS，LVS会选择一台服务器响应请求，在客户端与服务器之间建立隧道，返回结果的时候直接由服务器返回响应，不在经过LVS。")]),s._v(" "),n("li",[s._v("TUN模式必须所有的服务器上都绑定VIP的IP地址，所有的服务器都必须有网卡。")]),s._v(" "),n("li",[s._v("TUN模式走隧道运维难度大，并且会直接暴露服务器地址")]),s._v(" "),n("li",[s._v("服务器将应答包直接发给用户。所以，减少了负载均衡器的大量数据流动，负载均衡器不再是系统的瓶颈，就能处理很巨大的请求量，这种方式，一台负载均衡器能够为很多服务器进行分发。而且跑在公网上就能进行不同地域的分发")])]),s._v(" "),n("p",[s._v("(3)DR模式")]),s._v(" "),n("ul",[n("li",[s._v("客户端将请求发往LVS，LVS会选择一台服务器响应请求，返回结果的时候通过统一的路由进行返回，不在经过LVS。")]),s._v(" "),n("li",[s._v("和TUN模式一样，LVS只是分发请求，应答包通过单独的路由返回给客户端，与TUN相比这种方式不需要隧道结构，可以兼容大多数的操作系统，同时统一路由可以隐藏真实的物理服务器。DR模式效率更高，但配置更复杂.")]),s._v(" "),n("li",[s._v("所有服务器节点和LVS只能在一个局域网里面。")])]),s._v(" "),n("h5",{attrs:{id:"_3、搭建lvs-dr模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、搭建lvs-dr模式"}},[s._v("#")]),s._v(" 3、搭建LVS-DR模式")]),s._v(" "),n("p",[s._v("先关闭掉服务器上网络配置管理器，避免网络接口冲突")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl stop NetworkManager\nsystemctl disable NetworkManager\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("(1)创建子接口（创建LVS的虚拟ip）")]),s._v(" "),n("p",[s._v("进入网卡配置目录"),n("code",[s._v("/etc/sysconfig/network-scripts/")]),s._v(",找到网卡配置文件，这里以"),n("code",[s._v("ifcfg-ens33")]),s._v("为例，拷贝并创建子接口")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cp ifcfg-ens33 ifcfg-ens33:1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改子接口配置如下")]),s._v(" "),n("ul",[n("li",[s._v("配置中的 192.168.1.150 就是vip，是提供给外网用户访问的ip地址")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('DEVICE="ens33:1"\nONBOOT="yes"\nIPADDR=192.168.1.150\nNETMASK=255.255.255.0\nBOOTPROTO=static\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[s._v("重启网络服务")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("service network restart\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("重启成功后，ip addr 查看一下，你会发现多了一个ip，也就是虚拟ip（vip）")]),s._v(" "),n("blockquote",[n("p",[s._v("注意：阿里云不支持配置网卡，需要购买相应的负载均衡服务，腾讯云支持配置网卡，但需要购买网卡支持，一个网卡支持10个虚拟ip配置")])]),s._v(" "),n("p",[s._v("(2)安装ipvsadm")]),s._v(" "),n("p",[s._v("如今的centos都集成了LVS，所以ipvs是自带的，我们只需要安装ipvsadm即可（ipvsadm是管理集群的工具，通过ipvs可以管理集群，查看集群等操作）")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("yum install ipvsadm\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(3)配置服务器（RS）的虚拟ip")]),s._v(" "),n("p",[s._v("进入网卡配置目录"),n("code",[s._v("/etc/sysconfig/network-scripts/")]),s._v(",找到"),n("code",[s._v("ifcfg-lo")]),s._v("，拷贝并创建子接口")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("cp ifcfg-lo ifcfg-lo:1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("修改子接口配置如下")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('DEVICE="lo:1"\nIPADDR=192.168.1.150\nNETMASK=255.255.255.255\nNETWORK=127.0.0.0\nBROADCAST=127.255.255.255\nONBOOT="yes"\nNAME=loopback\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("重启网络服务成功后，"),n("code",[s._v("ip addr")]),s._v(" 查看一下，你会发现多了一个ip，也就是虚拟ip（vip）")]),s._v(" "),n("p",[s._v("(4)为服务器（RS）配置arp")]),s._v(" "),n("p",[s._v("ARP响应级别与通告行为参数说明")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("arp-ignore：ARP响应级别（处理请求）\n    0：只要本机配置了ip，就能响应请求\n    1：请求的目标地址到达对应的网络接口，才会响应请求\narp-announce：ARP通告行为（返回响应）\n    0：本机上任何网络接口都向外通告，所有的网卡都能接受到通告\n    1：尽可能避免本网卡与不匹配的目标进行通告2：只在本网卡通告\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("p",[s._v("打开sysctl.conf:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("vim /etc/sysctl.conf\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("配置所有网卡、默认网卡以及虚拟网卡的arp响应级别和通告行为，分别对应：all，default，lo")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# configration for lvs \nnet.ipv4.conf.all.arp_ignore = 1 \nnet.ipv4.conf.default.arp_ignore = 1 \nnet.ipv4.conf.lo.arp_ignore = 1 \n\nnet.ipv4.conf.all.arp_announce = 2 \nnet.ipv4.conf.default.arp_announce = 2 \nnet.ipv4.conf.lo.arp_announce = 2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("刷新配置文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("sysctl -p\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("增加一个网关，用于接收数据报文，当有请求到本机后，会交给lo去处理")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("route add -host 192.168.1.150 dev lo:1\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("将网关添加至开机启动")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('echo "route add -host 192.168.1.150 dev lo:1" >> /etc/rc.local\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("(4)使用ipvsadm配置集群规则")]),s._v(" "),n("p",[s._v("创建LVS节点，用户访问的集群调度者")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ipvsadm -A -t 192.168.1.150:80 -s rr -p 5\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("-A：添加集群")]),s._v(" "),n("li",[s._v("-t：tcp协议ip地址：设定集群的访问")]),s._v(" "),n("li",[s._v("ip：也就是LVS的虚拟ip")]),s._v(" "),n("li",[s._v("-s：设置负载均衡的算法，")]),s._v(" "),n("li",[s._v("rr：表示轮询")]),s._v(" "),n("li",[s._v("-p：设置连接持久化的时间,在指定时间内同一个用户的请求会访问到同一个服务器中")])]),s._v(" "),n("p",[s._v("创建多台RS真实服务器")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ipvsadm -a -t 192.168.1.150:80 -r 192.168.1.171:80 -g \nipvsadm -a -t 192.168.1.150:80 -r 192.168.1.172:80 -g\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("ul",[n("li",[s._v("-a：添加真实服务器")]),s._v(" "),n("li",[s._v("-t：tcp协议")]),s._v(" "),n("li",[s._v("-r：真实服务器的ip地址")]),s._v(" "),n("li",[s._v("-g：设定DR模式")])]),s._v(" "),n("p",[s._v("保存到规则库，否则重启失效")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ipvsadm -S\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("检查集群")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#查看集群列表\nipvsadm -Ln\n#查看集群状态\nipvsadm -Ln --stats\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("一些其他命令")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(" # 重启ipvsadm，重启后需要重新配置 \n service ipvsadm restart \n # 查看持久化连接 \n ipvsadm -Ln --persistent-conn \n # 查看连接请求过期时间以及请求源ip和目标ip \n ipvsadm -Lnc \n # 设置tcp tcpfin udp 的过期时间（一般保持默认） \n ipvsadm --set 1 1 1 \n # 查看过期时间 \n ipvsadm -Ln --timeout\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("(5)访问虚拟ip，完成LVS搭建")]),s._v(" "),n("h3",{attrs:{id:"附-lvs的负载均衡算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#附-lvs的负载均衡算法"}},[s._v("#")]),s._v(" 附：LVS的负载均衡算法")]),s._v(" "),n("h5",{attrs:{id:"_1-静态算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-静态算法"}},[s._v("#")]),s._v(" (1)静态算法")]),s._v(" "),n("p",[s._v("静态：根据LVS本身自由的固定的算法分发用户请求。")]),s._v(" "),n("ul",[n("li",[s._v("轮询（Round Robin 简写’rr’）：轮询算法假设所有的服务器处理请求的能力都一样的，调度器会把所有的请求平均分配给每个真实服务器。（同Nginx的轮询）")]),s._v(" "),n("li",[s._v("加权轮询（Weight Round Robin 简写’wrr’）：安装权重比例分配用户请求。权重越高，被分配到处理的请求越多。（同Nginx的权重）")]),s._v(" "),n("li",[s._v("源地址散列（Source Hash 简写’sh’）：同一个用户ip的请求，会由同一个RS来处理。（同Nginx的ip_hash）")]),s._v(" "),n("li",[s._v("目标地址散列（Destination Hash 简写’dh’）：根据url的不同，请求到不同的RS。（同Nginx的url_hash）")])]),s._v(" "),n("h5",{attrs:{id:"_2-动态算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-动态算法"}},[s._v("#")]),s._v(" (2)动态算法")]),s._v(" "),n("p",[s._v("动态：会根据流量的不同，或者服务器的压力不同来分配用户请求，这是动态计算的。")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("最小连接数（Least Connections 简写’lc’）：把新的连接请求分配到当前连接数最小的服务器。")])]),s._v(" "),n("li",[n("p",[s._v("加权最少连接数（Weight Least Connections 简写’wlc’）：服务器的处理性能用数值来代表，权重越大处理的请求越多。Real Server 有可能会存在性能上的差异，wlc动态获取不同服务器的负载状况，把请求分发到性能好并且比较空闲的服务器。")])]),s._v(" "),n("li",[n("p",[s._v("最短期望延迟（Shortest Expected Delay 简写’sed’）：特殊的wlc算法。举例阐述，假设有ABC三台服务器，权重分别为1、2、3 。如果使用wlc算法的话，当一个新请求进来，它可能会分给ABC中的任意一个。使用sed算法后会进行如下运算：")])]),s._v(" "),n("li",[n("ul",[n("li",[s._v("A：（1+1）/1=2")]),s._v(" "),n("li",[s._v("B：（1+2）/2=3/2")]),s._v(" "),n("li",[s._v("C：（1+3）/3=4/3")])])])]),s._v(" "),n("p",[s._v("最终结果，会把这个请求交给得出运算结果最小的服务器。最少队列调度（Never Queue 简写’nq’）：永不使用队列。如果有Real Server的连接数等于0，则直接把这个请求分配过去，不需要在排队等待运算了（sed运算）。")]),s._v(" "),n("h3",{attrs:{id:"八、搭建keepalived-lvs-nginx高可用集群负载均衡"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#八、搭建keepalived-lvs-nginx高可用集群负载均衡"}},[s._v("#")]),s._v(" 八、搭建Keepalived+Lvs+Nginx高可用集群负载均衡")]),s._v(" "),n("p",[s._v("如果原先服务器上配置了LVS+nginx需要清空ipvsadm中的配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("ipvsadm -C\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("如果配置了"),n("code",[s._v("Keepalived+Nginx")]),s._v("双主集群也需要去除掉Keepalived中原先的配置，按照的后文进行配置")]),s._v(" "),n("h5",{attrs:{id:"_1-使用keepalived配置master-lvs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-使用keepalived配置master-lvs"}},[s._v("#")]),s._v(" (1)使用keepalived配置Master LVS")]),s._v(" "),n("p",[s._v("在LVS的机器上安装keepalived，安装过程参考上文")]),s._v(" "),n("p",[s._v("(1)修改keepalived的配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs {\n    router_id keep_151 \n} \nvrrp_instance VI_1 { \n    state MASTER \n    interface ens33 \n    virtual_router_id 41 \n    priority 100 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.150\n    }\n} \n\n#配置集群访问的ip+端口，端口和nginx保持一致\nvirtual_server 192.168.1.150 80{\n    #健康检查的时间，单位：秒\n    delay_loop 6\n    #配置负载均衡的算法，默认的轮询\n    lb_algo rr\n    #设置LVS的模式 NAT|TUN|DR\n    lb-kind DR\n    #设置会话持久化的时间\n    persistence_timeout 5\n    #协议\n    protocol TCP\n    \n    #配置负载均衡的真实服务器，也就是nginx节点的具体的ip地址\n    real_server 192.168.1.171 80{\n        #轮询权重配比\n        weight 1\n        #设置健康检查\n        TCP_CHECK {\n            #检查80端口\n            connect_port 80\n            #超时时间\n            connect_timeout 2\n            #重试次数\n            nb_get_retry 2\n            #重试间隔时间\n            delay_before_retry 3\n        }\n    }\n    real_server 192.168.1.171 80{\n        weight 1\n        TCP_CHECK {\n            connect_port 80\n            connect_timeout 2\n            nb_get_retry 2\n            delay_before_retry 3\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])]),n("p",[s._v("(2)启动/重启keepalived")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("systemctl restart keepalived\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h5",{attrs:{id:"_2-使用keepalived配置backup-lvs"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-使用keepalived配置backup-lvs"}},[s._v("#")]),s._v(" (2)使用keepalived配置Backup LVS")]),s._v(" "),n("p",[s._v("配置在备用机上")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("global_defs {\n    router_id keep_152 \n} \nvrrp_instance VI_1 { \n    state  BACKUP\n    interface ens33 \n    virtual_router_id 41 \n    priority 50 \n    advert_int 1 \n    authentication { \n        auth_type PASS \n        auth_pass 1111 \n    } \n    virtual_ipaddress { \n        192.168.1.150\n    }\n} \n\n#配置集群访问的ip+端口，端口和nginx保持一致\nvirtual_server 192.168.1.150 80{\n    #健康检查的时间，单位：秒\n    delay_loop 6\n    #配置负载均衡的算法，默认的轮询\n    lb_algo rr\n    #设置LVS的模式 NAT|TUN|DR\n    lb-kind DR\n    #设置会话持久化的时间\n    persistence_timeout 5\n    #协议\n    protocol TCP\n    \n    #配置负载均衡的真实服务器，也就是nginx节点的具体的ip地址\n    real_server 192.168.1.171 80{\n        #轮询权重配比\n        weight 1\n        #设置健康检查\n        TCP_CHECK {\n            #检查80端口\n            connect_port 80\n            #超时时间\n            connect_timeout 2\n            #重试次数\n            nb_get_retry 2\n            #重试间隔时间\n            delay_before_retry 3\n        }\n    }\n    real_server 192.168.1.171 80{\n        weight 1\n        TCP_CHECK {\n            connect_port 80\n            connect_timeout 2\n            nb_get_retry 2\n            delay_before_retry 3\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);